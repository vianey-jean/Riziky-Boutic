import{u as K,_ as M,j as e,G as v,I as y,B as m,C as E,c as Q,k as V,l as z}from"./index-Dc-BS1W2.js";import{r as x}from"./emoji-mart-DRerY-OB.js";import{u as N,a as q}from"./useMutation-CApHjpg4.js";import{A as T}from"./AdminLayout-CibHDjhS.js";import{B as L}from"./badge-taJbTjbb.js";import{f as g}from"./flashSaleAPI-BHvs0iCz.js";import{p as O}from"./productsAPI-CcoVgeDh.js";import{D as $,b as B,d as G,c as R}from"./dialog-D1sIsNKu.js";import{T as S}from"./textarea-C2Rhkt_I.js";import{C as H}from"./checkbox-e3XHLN_v.js";import{S as J}from"./search-DlKIh_Ll.js";import{A as U,a as _,b as W,c as X,d as Y,e as Z,f as ee,g as te,h as se}from"./alert-dialog-BUmLs06s.js";import{P as k}from"./plus-DTTTuzsk.js";import{F as re,P as ae,a as ie}from"./play-C68uu85c.js";import{C as ne}from"./clock-U9VSJiyP.js";import{S as le}from"./square-pen-D72gPhkm.js";import{T as oe}from"./trash-2-DHce8VXy.js";import"./index-DrCm3EO8.js";import"./index-FHuIi1st.js";import"./Combination-DuTqoeZY.js";import"./index-DE01g13U.js";import"./index-DqWbzM0E.js";import"./index-C_ZzNLza.js";const de=({flashSale:a,products:o,onClose:h})=>{const[s,l]=x.useState({title:"",description:"",discount:0,startDate:"",endDate:"",productIds:[]}),[n,b]=x.useState(""),[D,j]=x.useState(o),{toast:c}=K(),u=M();x.useEffect(()=>{if(a){let t=[];Array.isArray(a.productIds)?t=a.productIds:a.productIds&&typeof a.productIds=="object"&&(t=Object.values(a.productIds)),l({title:a.title,description:a.description,discount:a.discount,startDate:a.startDate.slice(0,16),endDate:a.endDate.slice(0,16),productIds:t})}},[a]),x.useEffect(()=>{if(n.length>=3){const t=o.filter(r=>r.name.toLowerCase().includes(n.toLowerCase())||r.description.toLowerCase().includes(n.toLowerCase())||r.category.toLowerCase().includes(n.toLowerCase()));j(t)}else j(o)},[n,o]);const p=N({mutationFn:g.create,onSuccess:t=>{console.log("Flash sale créée avec succès:",t.data),u.invalidateQueries({queryKey:["admin-flash-sales"]}),u.invalidateQueries({queryKey:["active-flash-sale"]}),c({title:"Vente flash créée avec succès"}),h()},onError:t=>{console.error("Erreur lors de la création:",t),c({title:"Erreur lors de la création",variant:"destructive"})}}),f=N({mutationFn:({id:t,data:r})=>g.update(t,r),onSuccess:t=>{console.log("Flash sale mise à jour avec succès:",t.data),u.invalidateQueries({queryKey:["admin-flash-sales"]}),u.invalidateQueries({queryKey:["active-flash-sale"]}),c({title:"Vente flash mise à jour avec succès"}),h()},onError:t=>{console.error("Erreur lors de la mise à jour:",t),c({title:"Erreur lors de la mise à jour",variant:"destructive"})}}),A=t=>{if(t.preventDefault(),!s.title||!s.discount||!s.startDate||!s.endDate){c({title:"Veuillez remplir tous les champs requis",variant:"destructive"});return}if(new Date(s.endDate)<=new Date(s.startDate)){c({title:"La date de fin doit être après la date de début",variant:"destructive"});return}const r=Array.isArray(s.productIds)?s.productIds:[],i={title:s.title,description:s.description,discount:Number(s.discount),startDate:s.startDate,endDate:s.endDate,productIds:r};console.log("=== ENVOI DES DONNÉES ==="),console.log("Données complètes à envoyer:",JSON.stringify(i,null,2)),console.log("ProductIds sélectionnés:",r),console.log("Nombre de produits:",r.length),a?f.mutate({id:a.id,data:i}):p.mutate(i)},w=t=>{console.log("=== TOGGLE PRODUIT ==="),console.log("ID du produit cliqué:",t),l(r=>{const i=Array.isArray(r.productIds)?r.productIds:[];console.log("IDs actuels:",i);let d;return i.includes(t)?(d=i.filter(C=>C!==t),console.log("Produit retiré. Nouveaux IDs:",d)):(d=[...i,t],console.log("Produit ajouté. Nouveaux IDs:",d)),{...r,productIds:d}})},I=()=>{const t=Array.isArray(s.productIds)?s.productIds:[];return o.filter(i=>t.includes(i.id)).map(i=>i.name).join(", ")};return e.jsx($,{open:!0,onOpenChange:h,children:e.jsxs(B,{className:"max-w-4xl max-h-[90vh] overflow-y-auto",children:[e.jsx(G,{children:e.jsx(R,{children:a?"Modifier la vente flash":"Créer une nouvelle vente flash"})}),e.jsxs("form",{onSubmit:A,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"title",children:"Titre *"}),e.jsx(y,{id:"title",value:s.title,onChange:t=>l(r=>({...r,title:t.target.value})),placeholder:"Ex: Vente Flash Électronique",required:!0})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"discount",children:"Pourcentage de réduction *"}),e.jsx(y,{id:"discount",type:"number",min:"1",max:"99",value:s.discount,onChange:t=>l(r=>({...r,discount:parseInt(t.target.value)||0})),placeholder:"Ex: 50",required:!0})]})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"description",children:"Description"}),e.jsx(S,{id:"description",value:s.description,onChange:t=>l(r=>({...r,description:t.target.value})),placeholder:"Description de la vente flash...",rows:3})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx(v,{htmlFor:"startDate",children:"Date et heure de début *"}),e.jsx(y,{id:"startDate",type:"datetime-local",value:s.startDate,onChange:t=>l(r=>({...r,startDate:t.target.value})),required:!0})]}),e.jsxs("div",{children:[e.jsx(v,{htmlFor:"endDate",children:"Date et heure de fin *"}),e.jsx(y,{id:"endDate",type:"datetime-local",value:s.endDate,onChange:t=>l(r=>({...r,endDate:t.target.value})),required:!0})]})]}),e.jsxs("div",{children:[e.jsx(v,{className:"text-base font-medium",children:"Produits inclus dans la vente flash"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:["Sélectionnez les produits qui bénéficieront de la réduction de ",s.discount,"%"]}),e.jsxs("div",{className:"relative mb-4",children:[e.jsx(J,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),e.jsx(y,{type:"text",placeholder:"Rechercher des produits (minimum 3 caractères)...",value:n,onChange:t=>b(t.target.value),className:"pl-10"})]}),n.length>0&&n.length<3&&e.jsx("div",{className:"bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4",children:e.jsx("p",{className:"text-sm text-yellow-800",children:"Veuillez saisir au moins 3 caractères pour rechercher"})}),e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 max-h-60 overflow-y-auto border rounded-lg p-4",children:D.length===0?e.jsx("div",{className:"col-span-full text-center py-8 text-gray-500",children:n.length>=3?"Aucun produit trouvé":"Tous les produits"}):D.map(t=>e.jsxs("div",{className:"flex items-start space-x-3 p-2 hover:bg-gray-50 rounded",children:[e.jsx(H,{id:`product-${t.id}`,checked:Array.isArray(s.productIds)&&s.productIds.includes(t.id),onCheckedChange:()=>w(t.id)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("label",{htmlFor:`product-${t.id}`,className:"text-sm font-medium cursor-pointer block truncate",children:t.name}),e.jsxs("p",{className:"text-xs text-gray-500 truncate",children:[t.price,"€",s.discount>0&&e.jsxs("span",{className:"text-red-600 font-medium ml-2",children:["→ ",(t.price*(1-s.discount/100)).toFixed(2),"€"]})]}),e.jsx("p",{className:"text-xs text-gray-400 truncate",children:t.category})]})]},t.id))}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg mt-3",children:[e.jsxs("p",{className:"text-sm font-medium text-blue-800",children:[Array.isArray(s.productIds)?s.productIds.length:0," produit(s) sélectionné(s)"]}),Array.isArray(s.productIds)&&s.productIds.length>0&&e.jsxs("div",{className:"text-xs text-blue-600 mt-1",children:[e.jsx("p",{className:"font-medium",children:"Produits sélectionnés:"}),e.jsx("p",{className:"truncate",children:I()}),e.jsxs("p",{className:"mt-1",children:["IDs: ",s.productIds.join(", ")]})]})]})]}),e.jsxs("div",{className:"flex justify-end space-x-3 pt-4 border-t",children:[e.jsx(m,{type:"button",variant:"outline",onClick:h,children:"Annuler"}),e.jsx(m,{type:"submit",disabled:p.isPending||f.isPending,className:"bg-red-600 hover:bg-red-700",children:p.isPending||f.isPending?"Enregistrement...":a?"Mettre à jour":"Créer"})]})]})]})})},Le=()=>{const[a,o]=x.useState(!1),[h,s]=x.useState(null),{toast:l}=K(),n=M(),{data:b=[],isLoading:D}=q({queryKey:["admin-flash-sales"],queryFn:async()=>(await g.getAll()).data}),{data:j=[]}=q({queryKey:["admin-products"],queryFn:async()=>(await O.getAll()).data}),c=N({mutationFn:g.delete,onSuccess:()=>{n.invalidateQueries({queryKey:["admin-flash-sales"]}),l({title:"Vente flash supprimée avec succès"})},onError:()=>{l({title:"Erreur lors de la suppression",variant:"destructive"})}}),u=N({mutationFn:g.activate,onSuccess:()=>{n.invalidateQueries({queryKey:["admin-flash-sales"]}),n.invalidateQueries({queryKey:["active-flash-sale"]}),l({title:"Vente flash activée avec succès"})},onError:()=>{l({title:"Erreur lors de l'activation",variant:"destructive"})}}),p=N({mutationFn:g.deactivate,onSuccess:()=>{n.invalidateQueries({queryKey:["admin-flash-sales"]}),n.invalidateQueries({queryKey:["active-flash-sale"]}),l({title:"Vente flash désactivée avec succès"})},onError:()=>{l({title:"Erreur lors de la désactivation",variant:"destructive"})}}),f=t=>{const r=new Date(t),i=new Date,d=r.getTime()-i.getTime();if(d<=0)return"Expiré";const C=Math.floor(d/(1e3*60*60*24)),P=Math.floor(d%(1e3*60*60*24)/(1e3*60*60)),F=Math.floor(d%(1e3*60*60)/(1e3*60));return C>0?`${C}j ${P}h ${F}m`:P>0?`${P}h ${F}m`:`${F}m`},A=t=>{if(!t||t.length===0)return"Aucun produit";const r=j.filter(i=>t.includes(i.id));return r.length===0?"Produits non trouvés":r.map(i=>i.name).join(", ")},w=t=>{s(t),o(!0)},I=()=>{o(!1),s(null)};return D?e.jsx(T,{children:e.jsxs("div",{className:"text-center py-20",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-b-2 border-red-600 mx-auto mb-6"}),e.jsx("h2",{className:"text-xl font-semibold",children:"Chargement des ventes flash..."})]})}):e.jsx(T,{children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Gestion des Ventes Flash"}),e.jsx("p",{className:"text-gray-600 mt-1",children:"Créez et gérez vos ventes flash avec compte à rebours"})]}),e.jsxs(m,{onClick:()=>o(!0),className:"bg-red-600 hover:bg-red-700",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Nouvelle Vente Flash"]})]}),e.jsx("div",{className:"grid gap-6",children:b.length===0?e.jsx(E,{children:e.jsxs(Q,{className:"text-center py-12",children:[e.jsx(re,{className:"h-16 w-16 text-gray-400 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Aucune vente flash"}),e.jsx("p",{className:"text-gray-600 mb-4",children:"Créez votre première vente flash pour commencer"}),e.jsxs(m,{onClick:()=>o(!0),className:"bg-red-600 hover:bg-red-700",children:[e.jsx(k,{className:"h-4 w-4 mr-2"}),"Créer une vente flash"]})]})}):b.map(t=>{var r;return e.jsx(E,{className:"hover:shadow-lg transition-shadow",children:e.jsx(V,{children:e.jsxs("div",{className:"flex justify-between items-start",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center space-x-3 mb-2",children:[e.jsx(z,{className:"text-xl",children:t.title}),e.jsx(L,{variant:t.isActive?"default":"secondary",children:t.isActive?"Active":"Inactive"}),e.jsxs(L,{variant:"outline",className:"bg-red-50 text-red-600 border-red-200",children:["-",t.discount,"%"]})]}),e.jsx("p",{className:"text-gray-600 mb-3",children:t.description}),e.jsxs("div",{className:"bg-blue-50 p-3 rounded-lg mb-3",children:[e.jsxs("p",{className:"text-sm font-medium text-blue-800 mb-1",children:["Produits inclus (",((r=t.productIds)==null?void 0:r.length)||0,"):"]}),e.jsx("p",{className:"text-xs text-blue-600",children:A(t.productIds||[])})]}),e.jsxs("div",{className:"flex items-center space-x-4 text-sm text-gray-500",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(ne,{className:"h-4 w-4 mr-1"}),"Temps restant: ",f(t.endDate)]}),e.jsxs("div",{children:["Du ",new Date(t.startDate).toLocaleDateString()," au ",new Date(t.endDate).toLocaleDateString()]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx(m,{variant:"outline",size:"sm",onClick:()=>w(t),children:e.jsx(le,{className:"h-4 w-4"})}),e.jsx(m,{variant:"outline",size:"sm",onClick:()=>t.isActive?p.mutate(t.id):u.mutate(t.id),disabled:u.isPending||p.isPending,children:t.isActive?e.jsx(ae,{className:"h-4 w-4"}):e.jsx(ie,{className:"h-4 w-4"})}),e.jsxs(U,{children:[e.jsx(_,{asChild:!0,children:e.jsx(m,{variant:"outline",size:"sm",className:"text-red-600 hover:text-red-700",children:e.jsx(oe,{className:"h-4 w-4"})})}),e.jsxs(W,{children:[e.jsxs(X,{children:[e.jsx(Y,{children:"Supprimer la vente flash"}),e.jsx(Z,{children:"Êtes-vous sûr de vouloir supprimer cette vente flash ? Cette action est irréversible."})]}),e.jsxs(ee,{children:[e.jsx(te,{children:"Annuler"}),e.jsx(se,{onClick:()=>c.mutate(t.id),className:"bg-red-600 hover:bg-red-700",children:"Supprimer"})]})]})]})]})]})})},t.id)})}),a&&e.jsx(de,{flashSale:h,products:j,onClose:I})]})})};export{Le as default};
