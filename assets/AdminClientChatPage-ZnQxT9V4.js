import{d as Y,_ as Z,J as d,j as e,C as T,I as A,B as m}from"./index-Dc-BS1W2.js";import{r as l,$ as D,d as $}from"./emoji-mart-DRerY-OB.js";import{a as ee,u as S}from"./useMutation-CApHjpg4.js";import{c as u,P as q,a as L,b as P,D as se,d as re,e as te,f as Q,g as ae}from"./popover-CGZmNc4e.js";import{T as ne}from"./textarea-C2Rhkt_I.js";import{A as ie}from"./AdminLayout-CibHDjhS.js";import{S as R}from"./scroll-area-BfHT7kH_.js";import{B as le}from"./badge-taJbTjbb.js";import{S as oe}from"./search-DlKIh_Ll.js";import{U as k,S as z,a as ce}from"./user-DUzEMHwr.js";import{g as de}from"./index-DrCm3EO8.js";import{S as F}from"./square-pen-D72gPhkm.js";import{T as me}from"./trash-2-DHce8VXy.js";import"./Combination-DuTqoeZY.js";import"./index-CE35kS-Q.js";import"./index-C_ZzNLza.js";import"./index-BkNWx6m2.js";import"./index-DE01g13U.js";import"./index--K3sZeIh.js";const De=()=>{const{user:r}=Y(),[n,K]=l.useState(null),[f,g]=l.useState(""),[B,j]=l.useState(null),[v,h]=l.useState(""),[b,O]=l.useState(""),y=l.useRef(null),N=Z();l.useEffect(()=>{r&&r.email!=="service.client@example.com"&&d.error("Accès restreint au service client")},[r]);const{data:x,isLoading:J}=ee({queryKey:["serviceConversations"],queryFn:async()=>{try{return(await u.getServiceConversations()).data||{}}catch(s){return console.error("Erreur lors du chargement des conversations:",s),d.error("Erreur lors du chargement des conversations"),{}}},refetchInterval:5e3,enabled:!!r&&r.email==="service.client@example.com"}),U=S({mutationFn:async({conversationId:s,message:t})=>u.sendServiceReply(s,t),onSuccess:()=>{g(""),N.invalidateQueries({queryKey:["serviceConversations"]})},onError:s=>{console.error("Erreur lors de l'envoi du message:",s),d.error("Erreur lors de l'envoi du message")}}),w=S({mutationFn:async({messageId:s,content:t,conversationId:a})=>u.editMessage(s,t,a),onSuccess:()=>{j(null),h(""),N.invalidateQueries({queryKey:["serviceConversations"]})},onError:s=>{console.error("Erreur lors de la modification du message:",s),d.error("La modification du message a échoué")}}),V=S({mutationFn:async({messageId:s,conversationId:t})=>u.deleteMessage(s,t),onSuccess:()=>{N.invalidateQueries({queryKey:["serviceConversations"]}),d.success("Message supprimé avec succès")},onError:s=>{console.error("Erreur lors de la suppression du message:",s),d.error("La suppression du message a échoué")}});l.useEffect(()=>{if(r&&r.email==="service.client@example.com")return u.setOnline(),()=>{u.setOffline()}},[r]),l.useEffect(()=>{y.current&&y.current.scrollIntoView({behavior:"smooth"})},[n,x]);const C=()=>{!f.trim()||!n||U.mutate({conversationId:n,message:f})},_=s=>{!v.trim()||!n||w.mutate({messageId:s,content:v,conversationId:n})},G=s=>{j(s.id),h(s.content)},H=s=>{!n||!confirm("Êtes-vous sûr de vouloir supprimer ce message ?")||V.mutate({messageId:s,conversationId:n})},M=s=>new Date(s).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"}),W=s=>{g(t=>t+s.native)},X=s=>{h(t=>t+s.native)},E=x?Object.entries(x).filter(([s,t])=>{const a=t.clientInfo;if(!a)return!1;const o=`${a.nom} ${a.prenom||""}`.toLowerCase(),p=a.email.toLowerCase(),I=b.toLowerCase();return o.includes(I)||p.includes(I)}):[],c=n&&x?x[n]:null,i=c==null?void 0:c.clientInfo;return e.jsx(ie,{children:e.jsxs("div",{className:"h-full",children:[e.jsx("h1",{className:"text-3xl font-bold mb-6",children:"Service Client - Chat"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs(T,{className:"col-span-1 p-4 overflow-hidden flex flex-col",children:[e.jsx("div",{className:"mb-4",children:e.jsxs("div",{className:"relative",children:[e.jsx(oe,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-500"}),e.jsx(A,{placeholder:"Rechercher un client...",value:b,onChange:s=>O(s.target.value),className:"pl-9"})]})}),e.jsx(R,{className:"flex-1",children:e.jsx("div",{className:"space-y-2",children:J?e.jsx("p",{className:"text-center py-4 text-gray-500",children:"Chargement..."}):E.length===0?e.jsx("p",{className:"text-center py-4 text-gray-500",children:"Aucune conversation trouvée"}):E.map(([s,t])=>{const a=t.clientInfo,o=t.messages[t.messages.length-1],p=t.unreadCount||0;return e.jsxs("div",{className:`p-3 rounded-lg cursor-pointer transition-all ${n===s?"bg-red-100":"hover:bg-gray-100"}`,onClick:()=>K(s),children:[e.jsxs("div",{className:"flex items-center mb-1",children:[e.jsx("div",{className:"w-8 h-8 bg-gray-300 rounded-full flex items-center justify-center mr-2",children:e.jsx(k,{className:"h-4 w-4 text-gray-600"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("p",{className:"font-medium truncate",children:[a==null?void 0:a.nom," ",(a==null?void 0:a.prenom)||""]}),e.jsx("p",{className:"text-xs text-gray-500 truncate",children:a==null?void 0:a.email})]}),p>0&&e.jsx(le,{className:"bg-red-600",children:p})]}),o&&e.jsxs("div",{className:"mt-1",children:[e.jsxs("p",{className:"text-sm text-gray-500 truncate",children:[o.isSystemMessage?"Système: ":o.isAdminReply?"Vous: ":"Client: ",o.content]}),e.jsx("p",{className:"text-xs text-gray-400",children:M(o.timestamp)})]})]},s)})})})]}),e.jsx(T,{className:"col-span-1 md:col-span-3 p-0 flex flex-col overflow-hidden",children:n?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"p-4 border-b flex items-center",children:[e.jsx("div",{className:"w-10 h-10 bg-gray-300 rounded-full flex items-center justify-center mr-3",children:e.jsx(k,{className:"h-5 w-5 text-gray-600"})}),e.jsxs("div",{children:[e.jsxs("h3",{className:"font-medium",children:[i==null?void 0:i.nom," ",(i==null?void 0:i.prenom)||""]}),e.jsx("p",{className:"text-sm text-gray-500",children:i==null?void 0:i.email})]})]}),e.jsx(R,{className:"flex-1 p-4",children:e.jsxs("div",{className:"space-y-4",children:[c==null?void 0:c.messages.map(s=>e.jsx("div",{className:`flex ${s.isSystemMessage?"justify-center":s.senderId===(r==null?void 0:r.id)?"justify-end":"justify-start"}`,children:B===s.id?e.jsx("div",{className:"w-full max-w-[80%] bg-gray-50 p-3 rounded-lg",children:e.jsxs("div",{className:"flex",children:[e.jsx(A,{value:v,onChange:t=>h(t.target.value),className:"flex-1 mr-2"}),e.jsxs(q,{children:[e.jsx(L,{asChild:!0,children:e.jsx(m,{variant:"outline",size:"icon",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx(P,{className:"w-full p-0",side:"top",children:e.jsx(D,{data:$,onEmojiSelect:X,theme:"light"})})]}),e.jsx(m,{onClick:()=>_(s.id),className:"ml-2 bg-red-800 hover:bg-red-700",disabled:w.isPending,children:"Enregistrer"}),e.jsx(m,{variant:"ghost",onClick:()=>j(null),className:"ml-2",children:"Annuler"})]})}):e.jsxs("div",{className:`max-w-[80%] rounded-lg px-4 py-2 relative group ${s.isSystemMessage?"bg-gray-200 text-gray-700":s.senderId===(r==null?void 0:r.id)?"bg-green-600 text-white":"bg-blue-600 text-white"}`,children:[s.senderId===(r==null?void 0:r.id)&&!s.isSystemMessage&&e.jsxs(se,{children:[e.jsx(re,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"icon",className:"absolute right-0 top-0 opacity-0 group-hover:opacity-100 h-6 w-6 text-white",children:e.jsx(F,{className:"h-4 w-4"})})}),e.jsxs(te,{children:[e.jsxs(Q,{onClick:()=>G(s),children:[e.jsx(F,{className:"mr-2 h-4 w-4"})," Modifier"]}),e.jsx(ae,{}),e.jsxs(Q,{onClick:()=>H(s.id),className:"text-red-600",children:[e.jsx(me,{className:"mr-2 h-4 w-4"})," Supprimer"]})]})]}),e.jsx("p",{children:s.content}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsx("p",{className:`text-xs ${s.isSystemMessage?"text-gray-500":s.senderId===(r==null?void 0:r.id)?"text-green-100":"text-blue-100"}`,children:M(s.timestamp)}),s.isEdited&&e.jsx("p",{className:"text-xs ml-2 opacity-80",children:"(modifié)"})]})]})},s.id)),e.jsx("div",{ref:y})]})}),e.jsx("div",{className:"p-4 border-t",children:e.jsxs("form",{onSubmit:s=>{s.preventDefault(),C()},className:"flex space-x-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(ne,{value:f,onChange:s=>g(s.target.value),placeholder:"Écrivez votre réponse...",className:"resize-none pr-10",onKeyPress:s=>{s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),C())}}),e.jsxs(q,{children:[e.jsx(L,{asChild:!0,children:e.jsx(m,{variant:"ghost",size:"icon",className:"absolute right-2 bottom-2",children:e.jsx(z,{className:"h-4 w-4"})})}),e.jsx(P,{className:"w-full p-0",side:"top",children:e.jsx(D,{data:$,onEmojiSelect:W,theme:"light"})})]})]}),e.jsx(m,{type:"submit",className:"bg-red-800 hover:bg-red-700 self-end h-10",children:e.jsx(ce,{className:"h-4 w-4"})})]})})]}):e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-gray-500",children:[e.jsx(de,{className:"w-16 h-16 mb-4"}),e.jsx("p",{children:"Sélectionnez une conversation pour commencer"})]})})]})]})})};export{De as default};
